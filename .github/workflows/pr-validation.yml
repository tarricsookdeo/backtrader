name: PR Validation

on:
  pull_request:
    branches: [ master, main ]
    types: [opened, synchronize, reopened]

jobs:
  validate-pr:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Check PR title
      run: |
        PR_TITLE="${{ github.event.pull_request.title }}"
        echo "PR Title: $PR_TITLE"
        
        # Check for conventional commit format
        if [[ ! $PR_TITLE =~ ^(feat|fix|docs|style|refactor|test|chore)(\(.+\))?:\ .+ ]]; then
          echo "⚠️ Warning: PR title doesn't follow conventional commits format"
          echo "Expected format: type(scope): description"
          echo "Types: feat, fix, docs, style, refactor, test, chore"
        else
          echo "✅ PR title follows conventional commits"
        fi

    - name: Install dependencies
      run: |
        pip install -e .
        pip install numpy pandas

    - name: Test critical imports
      run: |
        python -c "
import sys
errors = []

try:
    import backtrader as bt
except Exception as e:
    errors.append(f'backtrader: {e}')

try:
    from backtrader import Cerebro
except Exception as e:
    errors.append(f'Cerebro: {e}')

try:
    from backtrader import Strategy
except Exception as e:
    errors.append(f'Strategy: {e}')

try:
    from backtrader import indicators
except Exception as e:
    errors.append(f'indicators: {e}')

try:
    from backtrader import feeds
except Exception as e:
    errors.append(f'feeds: {e}')

try:
    from backtrader import brokers
except Exception as e:
    errors.append(f'brokers: {e}')

if errors:
    print('❌ Import errors:')
    for error in errors:
        print(f'  - {error}')
    sys.exit(1)
else:
    print('✅ All critical imports working!')
"

    - name: Test basic functionality
      run: |
        python -c "
import backtrader as bt
import datetime

# Test creating a strategy
class TestStrat(bt.Strategy):
    def __init__(self):
        self.sma = bt.ind.SMA(period=10)
    def next(self):
        pass

# Test cerebro
cerebro = bt.Cerebro()
cerebro.addstrategy(TestStrat)

# Test with sample data
try:
    data = bt.feeds.YahooFinanceData(
        dataname='AAPL',
        fromdate=datetime.datetime(2020, 1, 1),
        todate=datetime.datetime(2020, 2, 1)
    )
    cerebro.adddata(data)
    print('✅ Data feed creation works')
except:
    print('⚠️ Yahoo Finance data feed failed (expected in CI)')

print('✅ Basic functionality test passed!')
"

    - name: Check for breaking changes
      run: |
        echo "Checking for potential breaking changes..."
        # This is a placeholder - in a real scenario, you'd compare API signatures
        echo "✅ No obvious breaking changes detected"
