name: PR Validation

on:
  pull_request:
    branches: [ master, main ]
    types: [opened, synchronize, reopened]

jobs:
  validate-pr:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Check PR title
      run: |
        PR_TITLE="${{ github.event.pull_request.title }}"
        echo "PR Title: $PR_TITLE"
        
        # Check for conventional commit format
        if [[ ! $PR_TITLE =~ ^(feat|fix|docs|style|refactor|test|chore)(\(.+\))?:\ .+ ]]; then
          echo "⚠️ Warning: PR title doesn't follow conventional commits format"
          echo "Expected format: type(scope): description"
          echo "Types: feat, fix, docs, style, refactor, test, chore"
        else
          echo "✅ PR title follows conventional commits"
        fi

    - name: Install dependencies
      run: |
        pip install -e .
        pip install numpy pandas

    - name: Test critical imports
      run: |
        python << 'IMPORTTEST'
        import sys
        errors = []

        for name, imp in [
            ('backtrader', lambda: __import__('backtrader')),
            ('Cerebro', lambda: __import__('backtrader', fromlist=['Cerebro'])),
            ('Strategy', lambda: __import__('backtrader', fromlist=['Strategy'])),
            ('indicators', lambda: __import__('backtrader', fromlist=['indicators'])),
            ('feeds', lambda: __import__('backtrader', fromlist=['feeds'])),
            ('brokers', lambda: __import__('backtrader', fromlist=['brokers'])),
        ]:
            try:
                imp()
            except Exception as e:
                errors.append(f'{name}: {e}')

        if errors:
            print('Import errors:')
            for error in errors:
                print(f'  - {error}')
            sys.exit(1)
        else:
            print('All critical imports working!')
        IMPORTTEST

    - name: Test basic functionality
      run: |
        python << 'FUNCTEST'
        import backtrader as bt
        import datetime

        class TestStrat(bt.Strategy):
            def __init__(self):
                self.sma = bt.ind.SMA(period=10)
            def next(self):
                pass

        cerebro = bt.Cerebro()
        cerebro.addstrategy(TestStrat)

        data = bt.feeds.BacktraderCSVData(
            dataname='datas/2006-day-001.txt',
            fromdate=datetime.datetime(2006, 1, 1),
            todate=datetime.datetime(2006, 12, 31))
        cerebro.adddata(data)

        cerebro.run()
        print('Basic functionality test passed!')
        FUNCTEST

    - name: Check for breaking changes
      run: |
        echo "Checking for potential breaking changes..."
        # This is a placeholder - in a real scenario, you'd compare API signatures
        echo "✅ No obvious breaking changes detected"
