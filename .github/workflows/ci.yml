name: CI

on:
  push:
    branches: [ master, main, 'modernize/**', 'ash/**' ]
  pull_request:
    branches: [ master, main ]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.8', '3.9', '3.10', '3.11', '3.12', '3.13']

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .
        pip install -e .[plotting]
        pip install numpy pandas matplotlib

    - name: Run tests
      run: |
        cd tests
        python -c "import sys; sys.path.insert(0, '..'); import backtrader; print(f'Backtrader {backtrader.__version__} loaded successfully')"
        # Run individual test files
        for test in test_*.py; do
          echo "Running $test..."
          python "$test" || echo "Warning: $test failed"
        done
      shell: bash

    - name: Test basic functionality
      run: |
        python << 'TESTSCRIPT'
        import backtrader as bt
        import datetime

        class TestStrategy(bt.Strategy):
            def __init__(self):
                self.dataclose = self.datas[0].close
                self.sma = bt.indicators.SMA(self.datas[0], period=15)

            def next(self):
                if self.dataclose[0] > self.sma[0]:
                    self.buy()

        cerebro = bt.Cerebro()
        cerebro.addstrategy(TestStrategy)

        data = bt.feeds.BacktraderCSVData(
            dataname='datas/2006-day-001.txt',
            fromdate=datetime.datetime(2006, 1, 1),
            todate=datetime.datetime(2006, 12, 31))

        cerebro.adddata(data)
        cerebro.broker.setcash(100000.0)
        cerebro.broker.setcommission(commission=0.001)

        print('Starting Portfolio Value: %.2f' % cerebro.broker.getvalue())
        cerebro.run()
        print('Final Portfolio Value: %.2f' % cerebro.broker.getvalue())
        print('SUCCESS: Backtrader is working!')
        TESTSCRIPT

  lint:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Install linting tools
      run: |
        python -m pip install --upgrade pip
        pip install ruff

    - name: Run Ruff linter
      run: |
        # Check for Python 2/3 compatibility issues and common errors
        ruff check backtrader/ --select E,W,F --ignore E501,E402,W293,E266,E265 || true
      continue-on-error: true

    - name: Check Python version compatibility
      run: |
        # Check for deprecated features that won't work in Python 3.13
        python << 'COMPATCHECK'
        import os

        deprecated_patterns = []

        for root, dirs, files in os.walk('backtrader'):
            for file in files:
                if file.endswith('.py'):
                    filepath = os.path.join(root, file)
                    with open(filepath, 'r') as f:
                        content = f.read()
                        lines = content.split('\n')
                        for i, line in enumerate(lines, 1):
                            if 'utcnow()' in line and 'datetime' in line:
                                deprecated_patterns.append(f'{filepath}:{i}: Uses utcnow()')
                            if 'collections.Iterable' in line or 'collections.Mapping' in line:
                                deprecated_patterns.append(f'{filepath}:{i}: Uses deprecated collections.abc')

        if deprecated_patterns:
            print('Found deprecated patterns:')
            for pattern in deprecated_patterns[:20]:
                print(f'  {pattern}')
            print(f'\nTotal: {len(deprecated_patterns)} occurrences')
        else:
            print('No deprecated patterns found!')
        COMPATCHECK

  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Install build dependencies
      run: |
        python -m pip install --upgrade pip
        pip install build twine

    - name: Build package
      run: |
        python -m build

    - name: Check package
      run: |
        twine check dist/*

    - name: Test installation
      run: |
        pip install dist/*.whl
        python -c "import backtrader; print(f'Installed backtrader {backtrader.__version__}')"

  compatibility-check:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'

    - name: Check Python 3.13 compatibility
      run: |
        pip install -e .
        python << 'COMPAT313'
        import sys
        print(f'Python version: {sys.version}')

        try:
            import backtrader as bt
            print('backtrader imports successfully')

            cerebro = bt.Cerebro()
            print('Cerebro class works')

            import collections.abc
            print('collections.abc available')

            print('\nPython 3.13 compatibility check passed!')
        except Exception as e:
            print(f'Error: {e}')
            sys.exit(1)
        COMPAT313
