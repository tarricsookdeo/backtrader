name: Benchmarks

on:
  push:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  performance:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .
        pip install numpy pandas matplotlib

    - name: Run performance benchmarks
      run: |
        python -c "
import time
import backtrader as bt
import datetime
import sys

class BenchmarkStrategy(bt.Strategy):
    params = (('sma_period', 15),)
    
    def __init__(self):
        self.sma = bt.indicators.SMA(self.data.close, period=self.params.sma_period)
        self.rsi = bt.indicators.RSI(self.data.close)
        
    def next(self):
        if self.sma[0] > self.data.close[0] and self.rsi[0] < 30:
            self.buy()
        elif self.sma[0] < self.data.close[0] and self.rsi[0] > 70:
            self.sell()

# Create sample data
data = bt.feeds.YahooFinanceData(
    dataname='AAPL',
    fromdate=datetime.datetime(2020, 1, 1),
    todate=datetime.datetime(2023, 12, 31)
)

# Benchmark 1: Single backtest
print('Running benchmarks...')
start = time.time()

cerebro = bt.Cerebro()
cerebro.addstrategy(BenchmarkStrategy)
cerebro.adddata(data)
cerebro.broker.setcash(100000.0)

cerebro.run()

elapsed = time.time() - start
print(f'Single backtest: {elapsed:.2f}s')

# Benchmark 2: Optimization
print('\\nRunning optimization benchmark...')
start = time.time()

cerebro = bt.Cerebro()
cerebro.optstrategy(BenchmarkStrategy, sma_period=range(10, 30, 5))
cerebro.adddata(data)
cerebro.broker.setcash(100000.0)
cerebro.run(maxcpus=1)  # Single CPU for consistent results

elapsed = time.time() - start
print(f'Optimization (4 runs): {elapsed:.2f}s')

print(f'\\nâœ… Benchmarks complete!')
"
