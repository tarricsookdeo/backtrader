name: Code Quality

on:
  push:
    branches: [ master, main, 'modernize/**', 'ash/**' ]
  pull_request:
    branches: [ master, main ]

jobs:
  code-analysis:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Install tools
      run: |
        python -m pip install --upgrade pip
        pip install ruff bandit

    - name: Run Ruff
      run: ruff check backtrader/ --select E,W,F,UP --ignore E501,E402,E265,E266,W293,UP009 --target-version py38 || true
      continue-on-error: true

    - name: Check Python 2 remnants
      run: |
        echo "Checking for __future__ imports..."
        grep -r "from __future__" backtrader/ --include="*.py" | wc -l | xargs echo "Found __future__ lines:"
        echo "Checking for with_metaclass..."
        grep -r "with_metaclass" backtrader/ --include="*.py" | wc -l | xargs echo "Found with_metaclass lines:"

    - name: Security check with Bandit
      run: bandit -r backtrader/ -ll || true
      continue-on-error: true
